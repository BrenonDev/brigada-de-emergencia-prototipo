<script>
const NUMERO_DESTINO = "5515981144802";

let watchID = null;
let precisaoMinima = 10;
let intervaloPrecisao = null;
let tipoEmergencia = "EMERGENCIA";
let ultimoLat = null;
let ultimoLon = null;
let ultimaPrecisao = null;
let timerBotao = null;
let timerSemGps = null;

function definirTipo(tipo){
  tipoEmergencia = tipo;
}

function mostrarLightbox(texto){
  document.getElementById("lightbox").style.display="flex";
  document.querySelector("#lightbox p").innerHTML = texto;
  document.getElementById("btnForcar").style.display="none";
}

function esconderLightbox(){
  document.getElementById("lightbox").style.display="none";
  clearTimeout(timerBotao);
  clearTimeout(timerSemGps);
}

function iniciarLocalizacao(){

  if(!navigator.geolocation){
    enviarWhatsApp(null,null,null);
    return;
  }

  precisaoMinima = 10;
  ultimoLat = null;
  ultimoLon = null;
  ultimaPrecisao = null;

  mostrarLightbox("<b>Ative a localização</b><br>Para enviar sua posição");

  timerSemGps = setTimeout(()=>{
    document.getElementById("btnForcar").style.display="block";
  },10000);

  watchID = navigator.geolocation.watchPosition(
    pos => {
      clearTimeout(timerSemGps);

      document.querySelector("#lightbox p").innerHTML =
      "<b>Localizando</b><br>Melhorando precisão do GPS";

      document.getElementById("btnForcar").style.display="none";

      precisaoMinima = 10;

      if(!intervaloPrecisao){
        intervaloPrecisao = setInterval(()=>{
          precisaoMinima += 5;
        },500);
      }

      ultimoLat = pos.coords.latitude;
      ultimoLon = pos.coords.longitude;
      ultimaPrecisao = pos.coords.accuracy;

      timerBotao = setTimeout(()=>{
        document.getElementById("btnForcar").style.display="block";
      },5000);

      if(ultimaPrecisao <= precisaoMinima){
        pararLocalizacao();
        enviarWhatsApp(ultimoLat,ultimoLon,ultimaPrecisao);
      }
    },
    err => {
      pararLocalizacao();
      enviarWhatsApp(null,null,null);
    },
    {
      enableHighAccuracy:true,
      maximumAge:0,
      timeout:20000
    }
  );
}

function enviarSemPrecisao(){
  pararLocalizacao();
  enviarWhatsApp(null,null,null);
}

function pararLocalizacao(){
  if(watchID){
    navigator.geolocation.clearWatch(watchID);
    watchID = null;
  }
  clearInterval(intervaloPrecisao);
  intervaloPrecisao = null;
  esconderLightbox();
}

function enviarWhatsApp(lat,lon,accuracy){
  let link = "Nao disponivel";
  let prec = "Nao disponivel";

  if(lat && lon){
    link = "https://maps.google.com/?q=" + lat + "," + lon + "&t=k";
  }

  if(accuracy){
    prec = Math.round(accuracy) + " metros";
  }

  const msg =
`PEDIDO DE AJUDA

Tipo: ${tipoEmergencia}

Localizacao: ${link}

Precisao: ${prec}`;

  const url = `https://wa.me/${NUMERO_DESTINO}?text=${encodeURIComponent(msg)}`;
  window.open(url,"_blank");
}
</script>
